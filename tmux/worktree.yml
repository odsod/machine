session: ${SESSION_NAME}
attach: true

root: ${HOME}/Code/${REPO_REL}

before_start:
  - test -n "${REPO_REL}"
  - test -n "${BRANCH}"
  - test -n "${SESSION_NAME}"
  - test -n "${AGENT_CMD}"
  - mkdir -p ${HOME}/Worktrees/${REPO_REL}
  - git -C ${HOME}/Code/${REPO_REL} fetch --prune origin || true
  - |
    if ! git -C "${HOME}/Worktrees/${REPO_REL}/${BRANCH}" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
      if git -C "${HOME}/Code/${REPO_REL}" show-ref --verify --quiet "refs/heads/${BRANCH}"; then
        git -C "${HOME}/Code/${REPO_REL}" worktree add "${HOME}/Worktrees/${REPO_REL}/${BRANCH}" "${BRANCH}"
      elif git -C "${HOME}/Code/${REPO_REL}" show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
        git -C "${HOME}/Code/${REPO_REL}" worktree add --track -b "${BRANCH}" "${HOME}/Worktrees/${REPO_REL}/${BRANCH}" "origin/${BRANCH}"
      else
        git -C "${HOME}/Code/${REPO_REL}" worktree add -b "${BRANCH}" "${HOME}/Worktrees/${REPO_REL}/${BRANCH}" HEAD
      fi
    fi

    if git -C "${HOME}/Code/${REPO_REL}" show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
      git -C "${HOME}/Worktrees/${REPO_REL}/${BRANCH}" checkout -B "${BRANCH}" "origin/${BRANCH}"
      git -C "${HOME}/Worktrees/${REPO_REL}/${BRANCH}" clean -fd
      git -C "${HOME}/Worktrees/${REPO_REL}/${BRANCH}" reset --hard "origin/${BRANCH}"
    fi

windows:
  - name: editor
    root: ${HOME}/Worktrees/${REPO_REL}/${BRANCH}
    layout: even-horizontal
    commands:
      - ${AGENT_CMD}
