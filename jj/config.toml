"$schema" = "https://jj-vcs.github.io/jj/latest/config-schema.json"

[user]
name = "Oscar SÃ¶derlund"
email = "odsod@users.noreply.github.com"

[templates]
git_push_bookmark = '"odsod/push-" ++ change_id.short()'
draft_commit_description = '''
concat(
  builtin_draft_commit_description,
  "\nJJ: ignore-rest\n",
  diff.git(),
)
'''

[aliases]
rebase-all = ["rebase", "-s", "(::trunk())+ & mutable()", "-d", "trunk()"]
# Optional per-repo migration: `jj bookmark forget main` to drop local main bookmark.
# Sync remote-tracking refs from origin.
sync = ["util", "exec", "--", "bash", "-lc", "set -euo pipefail; jj git fetch --remote origin >/dev/null; echo 'Synced refs from origin.'"]
# Prune merged odsod/push-* bookmarks that are already contained in main@origin.
clean = ["util", "exec", "--", "bash", "-lc", "set -euo pipefail; jj git fetch --remote origin >/dev/null; mapfile -t to_delete < <(for b in $(jj bookmark list | awk '/^odsod\\/push-/{gsub(\":\", \"\", $1); print $1}'); do if [ -n \"$(jj log -r \"bookmarks(\\\"$b\\\") & ::main@origin\" --no-graph)\" ]; then echo \"$b\"; fi; done); if [ ${#to_delete[@]} -eq 0 ]; then echo 'No merged odsod/push-* bookmarks to prune.'; exit 0; fi; echo 'Pruning bookmarks:'; printf '  %s\\n' \"${to_delete[@]}\"; jj bookmark delete \"${to_delete[@]}\"; jj git push --remote origin --deleted; echo 'Done.'"]
# Start a new empty working commit on top of latest main@origin.
start = ["util", "exec", "--", "bash", "-lc", "set -euo pipefail; jj git fetch --remote origin >/dev/null; jj new main@origin >/dev/null; echo 'Now working on a new commit on top of latest main@origin.'"]
# Run preflight only: fetch, mutable divergence check, and base-on-main check.
pr-check = ["util", "exec", "--", "bash", "-lc", "set -euo pipefail; jj git fetch --remote origin >/dev/null 2>&1; divergent=$(jj log -r 'mutable() & divergent()' --no-graph); if [ -n \"$divergent\" ]; then echo 'FAIL: mutable divergent change IDs detected.'; echo \"$divergent\"; exit 1; fi; if [ -z \"$(jj log -r '@ & descendants(main@origin)' --no-graph)\" ]; then echo 'FAIL: current commit is not rebased onto latest main@origin.'; echo 'Run: jj rebase -d main@origin'; exit 1; fi; echo 'OK: pr preflight checks passed.'"]
# Create a new PR for the current change-id bookmark after passing preflight.
pr = ["util", "exec", "--", "bash", "-lc", "set -euo pipefail; jj git fetch --remote origin >/dev/null 2>&1; divergent=$(jj log -r 'mutable() & divergent()' --no-graph); if [ -n \"$divergent\" ]; then echo 'Refusing jj pr: mutable divergent change IDs detected.'; echo \"$divergent\"; exit 1; fi; if [ -z \"$(jj log -r '@ & descendants(main@origin)' --no-graph)\" ]; then echo 'Refusing jj pr: current commit is not rebased onto latest main@origin.'; echo 'Run: jj rebase -d main@origin'; exit 1; fi; ws=$(jj workspace list -T 'if(self.target().current_working_copy(), self.name(), \"\") ++ \"\\n\"' | sed '/^$/d' | head -n1); repo=$(jj git remote list | awk '$1==\"origin\"{print $2; exit}' | sed -E 's#^git@github.com:##; s#^https://github.com/##; s#\\.git$##'); if [ -z \"$repo\" ]; then echo 'Could not infer GitHub repo from origin remote.'; exit 1; fi; head=''; if [ -n \"$ws\" ] && [ \"$ws\" != 'default' ] && [ -n \"$(jj log -r \"bookmarks(\\\"$ws\\\") & @\" --no-graph)\" ]; then head=\"$ws\"; jj bookmark track \"$head\" --remote=origin >/dev/null 2>&1 || true; jj git push --remote origin --bookmark \"$head\"; else jj git push -c @; head=\"odsod/push-$(jj log --no-graph -r @ -T 'change_id.short()')\"; fi; pr_url=$(gh pr create --repo \"$repo\" --head \"$head\" --fill); xdg-open \"$pr_url\" >/dev/null 2>&1 || true; echo \"$pr_url\""]
# Update an existing PR for the current change-id bookmark after passing preflight.
pr-update = ["util", "exec", "--", "bash", "-lc", "set -euo pipefail; jj git fetch --remote origin >/dev/null 2>&1; divergent=$(jj log -r 'mutable() & divergent()' --no-graph); if [ -n \"$divergent\" ]; then echo 'Refusing jj pr-update: mutable divergent change IDs detected.'; echo \"$divergent\"; exit 1; fi; if [ -z \"$(jj log -r '@ & descendants(main@origin)' --no-graph)\" ]; then echo 'Refusing jj pr-update: current commit is not rebased onto latest main@origin.'; echo 'Run: jj rebase -d main@origin'; exit 1; fi; ws=$(jj workspace list -T 'if(self.target().current_working_copy(), self.name(), \"\") ++ \"\\n\"' | sed '/^$/d' | head -n1); repo=$(jj git remote list | awk '$1==\"origin\"{print $2; exit}' | sed -E 's#^git@github.com:##; s#^https://github.com/##; s#\\.git$##'); if [ -z \"$repo\" ]; then echo 'Could not infer GitHub repo from origin remote.'; exit 1; fi; if [ -n \"$ws\" ] && [ \"$ws\" != 'default' ] && [ -n \"$(jj log -r \"bookmarks(\\\"$ws\\\") & @\" --no-graph)\" ]; then head=\"$ws\"; else head=\"odsod/push-$(jj log --no-graph -r @ -T 'change_id.short()')\"; fi; pr_number=$(gh pr list --repo \"$repo\" --state open --head \"$head\" --json number --jq '.[0].number'); if [ -z \"$pr_number\" ] || [ \"$pr_number\" = \"null\" ]; then echo \"No existing PR found for $head. Use jj pr to create one.\"; exit 1; fi; jj bookmark track \"$head\" --remote=origin >/dev/null 2>&1 || true; jj git push --remote origin --bookmark \"$head\"; pr_url=$(gh pr list --repo \"$repo\" --state open --head \"$head\" --json url --jq '.[0].url'); xdg-open \"$pr_url\" >/dev/null 2>&1 || true; echo \"$pr_url\""]
delta = ["diff", "--config", "ui.diff-formatter=\":git\"", "--config", "ui.pager=\"delta\""]

[revset-aliases]
upstream_work = "@ | ancestors(remote_bookmarks().., 2) | trunk()"

[revsets]
# Default view: current work + your bookmarked branches + latest upstream main context.
log = "present(@ | ancestors(@, 4) | (bookmarks() & mine()) | main@origin | descendants(main@origin, 4))"

[ui]
editor = ["nvim"]
default-command = ["log"]
show-diff-on-description-edit = true
pager = "delta"
diff-formatter = "difft"

[merge-tools.difft]
program = "difft"
diff-args = ["--color=always", "$left", "$right"]
